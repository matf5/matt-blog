<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rust 所有权系统 | matt的前端之路</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/matt-blog/cainiao.jpg">
    <meta name="description" content="matt的前端之路">
    
    <link rel="preload" href="/matt-blog/assets/css/0.styles.67df34d8.css" as="style"><link rel="preload" href="/matt-blog/assets/js/app.25e0c05f.js" as="script"><link rel="preload" href="/matt-blog/assets/js/2.778bb4ad.js" as="script"><link rel="preload" href="/matt-blog/assets/js/1.f8bb34da.js" as="script"><link rel="preload" href="/matt-blog/assets/js/43.fc442923.js" as="script"><link rel="prefetch" href="/matt-blog/assets/js/10.fde088a2.js"><link rel="prefetch" href="/matt-blog/assets/js/11.c62b6b34.js"><link rel="prefetch" href="/matt-blog/assets/js/12.27d4f152.js"><link rel="prefetch" href="/matt-blog/assets/js/13.3f3f6a36.js"><link rel="prefetch" href="/matt-blog/assets/js/14.eb7a3d07.js"><link rel="prefetch" href="/matt-blog/assets/js/15.114dfd5c.js"><link rel="prefetch" href="/matt-blog/assets/js/16.85253907.js"><link rel="prefetch" href="/matt-blog/assets/js/17.c2838453.js"><link rel="prefetch" href="/matt-blog/assets/js/18.3256f17f.js"><link rel="prefetch" href="/matt-blog/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/matt-blog/assets/js/20.0d880388.js"><link rel="prefetch" href="/matt-blog/assets/js/21.33b300c9.js"><link rel="prefetch" href="/matt-blog/assets/js/22.b7c97fbe.js"><link rel="prefetch" href="/matt-blog/assets/js/23.4db98f57.js"><link rel="prefetch" href="/matt-blog/assets/js/24.d445e64c.js"><link rel="prefetch" href="/matt-blog/assets/js/25.c039e47f.js"><link rel="prefetch" href="/matt-blog/assets/js/26.6d7abe1e.js"><link rel="prefetch" href="/matt-blog/assets/js/27.bfaa829f.js"><link rel="prefetch" href="/matt-blog/assets/js/28.84b83b90.js"><link rel="prefetch" href="/matt-blog/assets/js/29.bb7097bb.js"><link rel="prefetch" href="/matt-blog/assets/js/3.af33e5d6.js"><link rel="prefetch" href="/matt-blog/assets/js/30.1670eed9.js"><link rel="prefetch" href="/matt-blog/assets/js/31.f5bc0d9f.js"><link rel="prefetch" href="/matt-blog/assets/js/32.5f4a954a.js"><link rel="prefetch" href="/matt-blog/assets/js/33.6f9ca409.js"><link rel="prefetch" href="/matt-blog/assets/js/34.6f9326f3.js"><link rel="prefetch" href="/matt-blog/assets/js/35.6a2647bd.js"><link rel="prefetch" href="/matt-blog/assets/js/36.134fd2af.js"><link rel="prefetch" href="/matt-blog/assets/js/37.5d451018.js"><link rel="prefetch" href="/matt-blog/assets/js/38.f2a610a8.js"><link rel="prefetch" href="/matt-blog/assets/js/39.aff1ff99.js"><link rel="prefetch" href="/matt-blog/assets/js/4.45665f8a.js"><link rel="prefetch" href="/matt-blog/assets/js/40.3ac444af.js"><link rel="prefetch" href="/matt-blog/assets/js/41.894aac4a.js"><link rel="prefetch" href="/matt-blog/assets/js/42.89cd257f.js"><link rel="prefetch" href="/matt-blog/assets/js/44.13c91cd7.js"><link rel="prefetch" href="/matt-blog/assets/js/45.7242df67.js"><link rel="prefetch" href="/matt-blog/assets/js/46.15ff82f0.js"><link rel="prefetch" href="/matt-blog/assets/js/47.2188f04b.js"><link rel="prefetch" href="/matt-blog/assets/js/48.a7be1505.js"><link rel="prefetch" href="/matt-blog/assets/js/49.c492819b.js"><link rel="prefetch" href="/matt-blog/assets/js/5.7098d77a.js"><link rel="prefetch" href="/matt-blog/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/matt-blog/assets/js/7.6a854e57.js"><link rel="prefetch" href="/matt-blog/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/matt-blog/assets/css/0.styles.67df34d8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/matt-blog/" class="home-link router-link-active"><img src="/matt-blog/cainiao.jpg" alt="matt的前端之路" class="logo"> <span class="site-name can-hide">matt的前端之路</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hybrid</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>performance</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react-native</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/matt-blog/pages/rust/index.md" class="sidebar-heading clickable open"><span>Rust 学习</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/matt-blog/pages/rust/basic-syntax.html" class="sidebar-link">Rust 基础语法</a></li><li><a href="/matt-blog/pages/rust/ownership.html" aria-current="page" class="active sidebar-link">所有权系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#📋-本章内容" class="sidebar-link">📋 本章内容</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#所有权规则" class="sidebar-link">所有权规则</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#变量作用域" class="sidebar-link">变量作用域</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#数据交互方式" class="sidebar-link">数据交互方式</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#所有权与函数" class="sidebar-link">所有权与函数</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#引用与借用" class="sidebar-link">引用与借用</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#切片类型" class="sidebar-link">切片类型</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#💡-关键要点" class="sidebar-link">💡 关键要点</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#🎯-实践建议" class="sidebar-link">🎯 实践建议</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/rust/ownership.html#🔗-相关链接" class="sidebar-link">🔗 相关链接</a></li></ul></li><li><a href="/matt-blog/pages/rust/data-structures.html" class="sidebar-link">数据结构</a></li><li><a href="/matt-blog/pages/rust/collections.html" class="sidebar-link">集合类型</a></li><li><a href="/matt-blog/pages/rust/error-handling.html" class="sidebar-link">错误处理</a></li><li><a href="/matt-blog/pages/rust/generics-and-traits.html" class="sidebar-link">泛型与特征</a></li><li><a href="/matt-blog/pages/rust/functional-programming.html" class="sidebar-link">函数式编程</a></li><li><a href="/matt-blog/pages/rust/smart-pointers.html" class="sidebar-link">智能指针</a></li><li><a href="/matt-blog/pages/rust/tools-and-project.html" class="sidebar-link">工具与项目管理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/matt-blog/pages/qwik/index.md" class="sidebar-heading clickable"><span>Qwik 框架</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rust-所有权系统"><a href="#rust-所有权系统" class="header-anchor">#</a> Rust 所有权系统</h1> <p>所有权（Ownership）是 Rust 最独特和核心的特性，让 Rust 无需垃圾回收即可保证内存安全。</p> <h2 id="📋-本章内容"><a href="#📋-本章内容" class="header-anchor">#</a> 📋 本章内容</h2> <ul><li><a href="#%E6%89%80%E6%9C%89%E6%9D%83%E8%A7%84%E5%88%99">所有权规则</a></li> <li><a href="#%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F">变量作用域</a></li> <li><a href="#%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E6%96%B9%E5%BC%8F">数据交互方式</a></li> <li><a href="#%E6%89%80%E6%9C%89%E6%9D%83%E4%B8%8E%E5%87%BD%E6%95%B0">所有权与函数</a></li> <li><a href="#%E5%BC%95%E7%94%A8%E4%B8%8E%E5%80%9F%E7%94%A8">引用与借用</a></li> <li><a href="#%E5%88%87%E7%89%87%E7%B1%BB%E5%9E%8B">切片类型</a></li></ul> <h2 id="所有权规则"><a href="#所有权规则" class="header-anchor">#</a> 所有权规则</h2> <p>Rust 中的每一个值都有一个被称为其**所有者（owner）**的变量。</p> <h3 id="三条基本规则"><a href="#三条基本规则" class="header-anchor">#</a> 三条基本规则</h3> <ol><li><strong>Rust 中的每一个值都有一个被称为其所有者的变量</strong></li> <li><strong>值在任一时刻有且只有一个所有者</strong></li> <li><strong>当所有者（变量）离开作用域，这个值将被丢弃</strong></li></ol> <h2 id="变量作用域"><a href="#变量作用域" class="header-anchor">#</a> 变量作用域</h2> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">{</span>                      <span class="token comment">// s 在这里无效, 它尚未声明</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>   <span class="token comment">// 从此处起，s 开始有效</span>

    <span class="token comment">// 使用 s</span>
<span class="token punctuation">}</span>                      <span class="token comment">// 此作用域已结束，s 不再有效</span>
</code></pre></div><h3 id="string-类型"><a href="#string-类型" class="header-anchor">#</a> String 类型</h3> <p><code>String</code> 类型管理被分配到堆上的数据，因此能够存储在编译时未知大小的文本：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

s<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;, world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push_str() 在字符串后追加字面值</span>

<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将打印 `hello, world!`</span>
</code></pre></div><h2 id="数据交互方式"><a href="#数据交互方式" class="header-anchor">#</a> 数据交互方式</h2> <h3 id="方式一-移动-move"><a href="#方式一-移动-move" class="header-anchor">#</a> 方式一：移动（Move）</h3> <p>对于 <code>String</code> 类型，为了支持一个可变、可增长的文本片段，需要在堆上分配一块在编译时未知大小的内存来存放内容。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">;</span>

<span class="token comment">// println!(&quot;{}&quot;, s1); // 错误！s1 已被移动</span>
</code></pre></div><p><strong>内存布局图示</strong>：</p> <p><img src="https://raw.githubusercontent.com/matf5/fileCache/master/20240425163816.png" alt="栈和堆的内存布局"></p> <p>左侧为栈，右侧为堆</p> <p><img src="https://raw.githubusercontent.com/matf5/fileCache/master/20240425164109.png" alt="移动后的内存状态"></p> <p>移动之后只有 <code>s2</code> 有效，<code>s1</code> 会被释放</p> <p><strong>重要概念</strong>：</p> <ul><li><strong>长度（Length）</strong>：<code>String</code> 的内容当前使用了多少字节的内存</li> <li><strong>容量（Capacity）</strong>：<code>String</code> 从分配器总共获取了多少字节的内存</li></ul> <h3 id="方式二-克隆-clone"><a href="#方式二-克隆-clone" class="header-anchor">#</a> 方式二：克隆（Clone）</h3> <p>如果我们<strong>确实</strong>需要深度复制 <code>String</code> 中堆上的数据，可以使用 <code>clone</code> 方法：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;s1 = {}, s2 = {}&quot;</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这样就可以正常工作了</span>
</code></pre></div><h3 id="方式三-拷贝-copy"><a href="#方式三-拷贝-copy" class="header-anchor">#</a> 方式三：拷贝（Copy）</h3> <p>栈上的数据可以快速复制，因此赋值后原变量仍然可用：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> x<span class="token punctuation">;</span>

<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;x = {}, y = {}&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 都有效</span>
</code></pre></div><h4 id="copy-trait"><a href="#copy-trait" class="header-anchor">#</a> Copy trait</h4> <p>如果一个类型实现了 <code>Copy</code> trait，那么一个旧的变量在将其赋值给其他变量后仍然可用。</p> <p><strong>实现了 <code>Copy</code> trait 的类型</strong>：</p> <ul><li>所有整数类型，比如 <code>u32</code></li> <li>布尔类型，<code>bool</code></li> <li>所有浮点数类型，比如 <code>f64</code></li> <li>字符类型，<code>char</code></li> <li>元组，当且仅当其包含的类型也都实现 <code>Copy</code> 的时候。比如，<code>(i32, i32)</code> 实现了 <code>Copy</code>，但 <code>(i32, String)</code> 就没有</li></ul> <h2 id="所有权与函数"><a href="#所有权与函数" class="header-anchor">#</a> 所有权与函数</h2> <p>将值传递给函数在语义上与给变量赋值相似。向函数传递值可能会移动或者复制，就像赋值语句一样。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// s 进入作用域</span>

    <span class="token function">takes_ownership</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// s 的值移动到函数里 ...</span>
                                    <span class="token comment">// ... 所以到这里不再有效</span>

    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>                      <span class="token comment">// x 进入作用域</span>

    <span class="token function">makes_copy</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// x 应该移动函数里，</span>
                                    <span class="token comment">// 但 i32 是 Copy 的，所以在后面可继续使用 x</span>

<span class="token punctuation">}</span> <span class="token comment">// 这里, x 先移出了作用域，然后是 s。但因为 s 的值已被移走，</span>
  <span class="token comment">// 所以不会有特殊操作</span>

<span class="token keyword">fn</span> <span class="token function-definition function">takes_ownership</span><span class="token punctuation">(</span>some_string<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// some_string 进入作用域</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> some_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// 这里，some_string 移出作用域并调用 `drop` 方法。占用的内存被释放</span>

<span class="token keyword">fn</span> <span class="token function-definition function">makes_copy</span><span class="token punctuation">(</span>some_integer<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// some_integer 进入作用域</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> some_integer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// 这里，some_integer 移出作用域。不会有特殊操作</span>
</code></pre></div><h3 id="返回值与作用域"><a href="#返回值与作用域" class="header-anchor">#</a> 返回值与作用域</h3> <p>返回值也可以转移所有权：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token function">gives_ownership</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// gives_ownership 将返回值</span>
                                        <span class="token comment">// 移给 s1</span>

    <span class="token keyword">let</span> s2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// s2 进入作用域</span>

    <span class="token keyword">let</span> s3 <span class="token operator">=</span> <span class="token function">takes_and_gives_back</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// s2 被移动到</span>
                                        <span class="token comment">// takes_and_gives_back 中,</span>
                                        <span class="token comment">// 它也将返回值移给 s3</span>
<span class="token punctuation">}</span> <span class="token comment">// 这里, s3 移出作用域并被丢弃。s2 也移出作用域，但已被移走，</span>
  <span class="token comment">// 所以什么也不会发生。s1 移出作用域并被丢弃</span>

<span class="token keyword">fn</span> <span class="token function-definition function">gives_ownership</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>           <span class="token comment">// gives_ownership 将返回值移动给</span>
                                           <span class="token comment">// 调用它的函数</span>

    <span class="token keyword">let</span> some_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;yours&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// some_string 进入作用域</span>

    some_string                              <span class="token comment">// 返回 some_string 并移出给调用的函数</span>
<span class="token punctuation">}</span>

<span class="token comment">// takes_and_gives_back 将传入字符串并返回该值</span>
<span class="token keyword">fn</span> <span class="token function-definition function">takes_and_gives_back</span><span class="token punctuation">(</span>a_string<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token comment">// a_string 进入作用域</span>

    a_string  <span class="token comment">// 返回 a_string 并移出给调用的函数</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="引用与借用"><a href="#引用与借用" class="header-anchor">#</a> 引用与借用</h2> <p>引用（reference）像一个指针，因为它是一个地址，我们可以由此访问储存于该地址的属于其他变量的数据。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token function">calculate_length</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The length of '{}' is {}.&quot;</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">calculate_length</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://raw.githubusercontent.com/matf5/fileCache/master/20240425165744.png" alt="引用示意图"></p> <h3 id="可变引用"><a href="#可变引用" class="header-anchor">#</a> 可变引用</h3> <p>正常引用是不可变的，无法通过引用修改内容。如果要可变，可以修改为 <code>&amp;mut</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">change</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">change</span><span class="token punctuation">(</span>some_string<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    some_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;, world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="可变引用的限制"><a href="#可变引用的限制" class="header-anchor">#</a> 可变引用的限制</h3> <p>在同一时间，只能有一个对某一特定数据的可变引用。尝试创建两个可变引用的代码将会失败：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span>
<span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span> <span class="token comment">// 错误！</span>

<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}, {}&quot;</span><span class="token punctuation">,</span> r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但以下代码没问题：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span> <span class="token comment">// 没问题</span>
<span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span> <span class="token comment">// 没问题</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} and {}&quot;</span><span class="token punctuation">,</span> r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 此位置之后 r1 和 r2 不再使用</span>

<span class="token keyword">let</span> r3 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span> <span class="token comment">// 没问题</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="悬垂引用-dangling-references"><a href="#悬垂引用-dangling-references" class="header-anchor">#</a> 悬垂引用（Dangling References）</h3> <p>悬垂引用是指引用了一个已经被释放的内存地址：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> reference_to_nothing <span class="token operator">=</span> <span class="token function">dangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">dangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token comment">// 错误！</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>s <span class="token comment">// 这里s离开作用域已经被释放掉了</span>
<span class="token punctuation">}</span>
</code></pre></div><p>正确的做法是直接返回 <code>String</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">no_dangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    s <span class="token comment">// 所有权被移动出去，所以没有值被释放</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="引用的规则"><a href="#引用的规则" class="header-anchor">#</a> 引用的规则</h3> <ol><li><strong>在任意给定时间，要么只能有一个可变引用，要么只能有多个不可变引用</strong></li> <li><strong>引用必须总是有效的</strong></li></ol> <h3 id="解引用操作符"><a href="#解引用操作符" class="header-anchor">#</a> 解引用操作符 (*)</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token operator">&amp;</span>x<span class="token punctuation">;</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解引用</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="切片类型"><a href="#切片类型" class="header-anchor">#</a> 切片类型</h2> <p>切片（slice）让你引用集合中一段连续的元素序列，而不用引用整个集合。</p> <h3 id="字符串切片"><a href="#字符串切片" class="header-anchor">#</a> 字符串切片</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> world <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">..</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 语法糖</span>
<span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 从开始到索引5</span>
<span class="token keyword">let</span> world <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 从索引6到结束</span>
<span class="token keyword">let</span> entire <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 整个字符串</span>
</code></pre></div><h3 id="字符串切片的实际应用"><a href="#字符串切片的实际应用" class="header-anchor">#</a> 字符串切片的实际应用</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">first_word</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> bytes <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>item<span class="token punctuation">)</span> <span class="token keyword">in</span> bytes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> item <span class="token operator">==</span> <span class="token char">b' '</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// `first_word` 接受 `String` 的切片，无论是部分还是全部</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// `first_word` 也接受 `String` 的引用，</span>
    <span class="token comment">// 这等同于 `String` 的全部切片</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> my_string_literal <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// `first_word` 接受字符串字面量的切片，无论是部分还是全部</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string_literal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string_literal<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 字符串字面量就是切片</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span>my_string_literal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="更好的-first-word-实现"><a href="#更好的-first-word-实现" class="header-anchor">#</a> 更好的 <code>first_word</code> 实现</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">first_word</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> bytes <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>item<span class="token punctuation">)</span> <span class="token keyword">in</span> bytes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> item <span class="token operator">==</span> <span class="token char">b' '</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="其他切片"><a href="#其他切片" class="header-anchor">#</a> 其他切片</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>slice<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="💡-关键要点"><a href="#💡-关键要点" class="header-anchor">#</a> 💡 关键要点</h2> <ol><li><strong>所有权系统确保内存安全</strong>：在编译时防止数据竞争和内存泄漏</li> <li><strong>移动语义是默认行为</strong>：避免意外的深拷贝</li> <li><strong>借用检查器</strong>：确保引用的有效性</li> <li><strong>生命周期</strong>：确保引用不会超过其指向的值</li> <li><strong>切片提供安全的局部访问</strong>：无需拥有整个集合的所有权</li></ol> <h2 id="🎯-实践建议"><a href="#🎯-实践建议" class="header-anchor">#</a> 🎯 实践建议</h2> <ol><li><strong>优先使用借用而非获取所有权</strong></li> <li><strong>明确区分可变和不可变引用</strong></li> <li><strong>利用切片进行安全的序列操作</strong></li> <li><strong>理解移动语义，避免在移动后使用变量</strong></li> <li><strong>善用 <code>clone()</code> 进行必要的深拷贝</strong></li></ol> <h2 id="🔗-相关链接"><a href="#🔗-相关链接" class="header-anchor">#</a> 🔗 相关链接</h2> <ul><li><strong>上一章</strong>: <a href="/matt-blog/pages/rust/tools-and-project.html">工具与项目管理</a></li> <li><strong>下一章</strong>: <a href="/matt-blog/pages/rust/data-structures.html">数据结构</a></li> <li><strong>相关概念</strong>: <a href="/matt-blog/pages/rust/generics-and-traits.html">泛型与特征</a></li></ul> <hr> <p><a href="/matt-blog/pages/rust/" class="router-link-active">返回索引</a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/matt-blog/pages/rust/basic-syntax.html" class="prev">
        Rust 基础语法
      </a></span> <span class="next"><a href="/matt-blog/pages/rust/data-structures.html">
        数据结构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/matt-blog/assets/js/app.25e0c05f.js" defer></script><script src="/matt-blog/assets/js/2.778bb4ad.js" defer></script><script src="/matt-blog/assets/js/1.f8bb34da.js" defer></script><script src="/matt-blog/assets/js/43.fc442923.js" defer></script>
  </body>
</html>
