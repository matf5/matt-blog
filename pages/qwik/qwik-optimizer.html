<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Qwik Optimizer | matt的前端之路</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/matt-blog/cainiao.jpg">
    <meta name="description" content="matt的前端之路">
    
    <link rel="preload" href="/matt-blog/assets/css/0.styles.67df34d8.css" as="style"><link rel="preload" href="/matt-blog/assets/js/app.71e86090.js" as="script"><link rel="preload" href="/matt-blog/assets/js/2.778bb4ad.js" as="script"><link rel="preload" href="/matt-blog/assets/js/1.f8bb34da.js" as="script"><link rel="preload" href="/matt-blog/assets/js/34.88ebc733.js" as="script"><link rel="prefetch" href="/matt-blog/assets/js/10.fde088a2.js"><link rel="prefetch" href="/matt-blog/assets/js/11.c62b6b34.js"><link rel="prefetch" href="/matt-blog/assets/js/12.27d4f152.js"><link rel="prefetch" href="/matt-blog/assets/js/13.3f3f6a36.js"><link rel="prefetch" href="/matt-blog/assets/js/14.eb7a3d07.js"><link rel="prefetch" href="/matt-blog/assets/js/15.114dfd5c.js"><link rel="prefetch" href="/matt-blog/assets/js/16.85253907.js"><link rel="prefetch" href="/matt-blog/assets/js/17.c2838453.js"><link rel="prefetch" href="/matt-blog/assets/js/18.3256f17f.js"><link rel="prefetch" href="/matt-blog/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/matt-blog/assets/js/20.0d880388.js"><link rel="prefetch" href="/matt-blog/assets/js/21.33b300c9.js"><link rel="prefetch" href="/matt-blog/assets/js/22.b7c97fbe.js"><link rel="prefetch" href="/matt-blog/assets/js/23.4db98f57.js"><link rel="prefetch" href="/matt-blog/assets/js/24.d02ac95a.js"><link rel="prefetch" href="/matt-blog/assets/js/25.2773990a.js"><link rel="prefetch" href="/matt-blog/assets/js/26.3f9a83a0.js"><link rel="prefetch" href="/matt-blog/assets/js/27.76956e48.js"><link rel="prefetch" href="/matt-blog/assets/js/28.d91bf143.js"><link rel="prefetch" href="/matt-blog/assets/js/29.a466f468.js"><link rel="prefetch" href="/matt-blog/assets/js/3.af33e5d6.js"><link rel="prefetch" href="/matt-blog/assets/js/30.22bee9f6.js"><link rel="prefetch" href="/matt-blog/assets/js/31.1d76566f.js"><link rel="prefetch" href="/matt-blog/assets/js/32.c4bb4de8.js"><link rel="prefetch" href="/matt-blog/assets/js/33.519c9cbd.js"><link rel="prefetch" href="/matt-blog/assets/js/35.eff53b64.js"><link rel="prefetch" href="/matt-blog/assets/js/36.82f9ebe4.js"><link rel="prefetch" href="/matt-blog/assets/js/37.159089ca.js"><link rel="prefetch" href="/matt-blog/assets/js/38.ed6658c8.js"><link rel="prefetch" href="/matt-blog/assets/js/39.aad63f87.js"><link rel="prefetch" href="/matt-blog/assets/js/4.45665f8a.js"><link rel="prefetch" href="/matt-blog/assets/js/40.039f9789.js"><link rel="prefetch" href="/matt-blog/assets/js/41.2a8e9d15.js"><link rel="prefetch" href="/matt-blog/assets/js/42.a714b810.js"><link rel="prefetch" href="/matt-blog/assets/js/43.10b4130b.js"><link rel="prefetch" href="/matt-blog/assets/js/44.59650f89.js"><link rel="prefetch" href="/matt-blog/assets/js/45.96e83476.js"><link rel="prefetch" href="/matt-blog/assets/js/46.53181746.js"><link rel="prefetch" href="/matt-blog/assets/js/47.fdee3dd3.js"><link rel="prefetch" href="/matt-blog/assets/js/48.5fb19d7f.js"><link rel="prefetch" href="/matt-blog/assets/js/49.5e450d62.js"><link rel="prefetch" href="/matt-blog/assets/js/5.7098d77a.js"><link rel="prefetch" href="/matt-blog/assets/js/50.3dee0a22.js"><link rel="prefetch" href="/matt-blog/assets/js/51.7403a464.js"><link rel="prefetch" href="/matt-blog/assets/js/52.39fbb785.js"><link rel="prefetch" href="/matt-blog/assets/js/53.1750e5fe.js"><link rel="prefetch" href="/matt-blog/assets/js/54.6154a915.js"><link rel="prefetch" href="/matt-blog/assets/js/55.67d3b7c1.js"><link rel="prefetch" href="/matt-blog/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/matt-blog/assets/js/7.6a854e57.js"><link rel="prefetch" href="/matt-blog/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/matt-blog/assets/css/0.styles.67df34d8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/matt-blog/" class="home-link router-link-active"><img src="/matt-blog/cainiao.jpg" alt="matt的前端之路" class="logo"> <span class="site-name can-hide">matt的前端之路</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hybrid</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mini-program</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>performance</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目经验剖析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>qwik</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/matt-blog/pages/qwik/" aria-current="page" class="sidebar-link">Qwik 框架学习指南</a></li><li><a href="/matt-blog/pages/qwik/qwik-core-concepts.html" class="sidebar-link">Qwik 核心思想</a></li><li><a href="/matt-blog/pages/qwik/qwik-extension-tools.html" class="sidebar-link">Qwik 拓展工具</a></li><li><a href="/matt-blog/pages/qwik/qwik-introduction.html" class="sidebar-link">Qwik 介绍</a></li><li><a href="/matt-blog/pages/qwik/qwik-optimizer.html" aria-current="page" class="active sidebar-link">Qwik Optimizer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#方法原理" class="sidebar-link">$ 方法原理</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#编译原理" class="sidebar-link">编译原理</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#依赖处理" class="sidebar-link">依赖处理</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#qrl-运行时" class="sidebar-link">QRL 运行时</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#优化策略" class="sidebar-link">优化策略</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#编译配置" class="sidebar-link">编译配置</a></li><li class="sidebar-sub-header"><a href="/matt-blog/pages/qwik/qwik-optimizer.html#性能指标" class="sidebar-link">性能指标</a></li></ul></li><li><a href="/matt-blog/pages/qwik/qwik-principles.html" class="sidebar-link">Qwik 原理</a></li><li><a href="/matt-blog/pages/qwik/summary.html" class="sidebar-link">学习总结</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react-native</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>rust</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>xiaochengxu</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="qwik-optimizer"><a href="#qwik-optimizer" class="header-anchor">#</a> Qwik Optimizer</h1> <p>Qwik Optimizer 是 Qwik 的核心编译工具，负责代码拆分、优化和转换。</p> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>Qwik Optimizer 是 Qwik 单独抽离的包：</p> <ul><li><strong>基于 Rust 编写</strong>：提供 WASM 包，性能极高</li> <li><strong>编译构建</strong>：压缩、Tree Shaking 等</li> <li><strong>序列化处理</strong>：在编译阶段确定序列化数据</li> <li><strong>代码拆分</strong>：提供 <code>$</code>、<code>Component$</code> 等方法</li></ul> <h2 id="方法原理"><a href="#方法原理" class="header-anchor">#</a> $ 方法原理</h2> <h3 id="传统-lazy-load"><a href="#传统-lazy-load" class="header-anchor">#</a> 传统 Lazy Load</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 传统方式：手动分离 chunk</span>
<span class="token comment">// calculate.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 重逻辑</span>
  <span class="token keyword">return</span> <span class="token function">heavyCalculation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// main.js</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>someCondition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> calculate <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./calculate.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="qwik-的-方法"><a href="#qwik-的-方法" class="header-anchor">#</a> Qwik 的 $ 方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Qwik 方式：自动分包</span>
<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> calculate <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重逻辑</span>
    <span class="token keyword">return</span> <span class="token function">heavyCalculation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>someCondition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="方法的优势"><a href="#方法的优势" class="header-anchor">#</a> $ 方法的优势</h3> <ol><li><strong>自动化</strong>：无需手动分离代码</li> <li><strong>细粒度</strong>：可以拆分到函数级别</li> <li><strong>智能分析</strong>：自动分析依赖关系</li> <li><strong>开发体验</strong>：编写代码时无需考虑分包</li></ol> <h2 id="编译原理"><a href="#编译原理" class="header-anchor">#</a> 编译原理</h2> <h3 id="基于-swc"><a href="#基于-swc" class="header-anchor">#</a> 基于 SWC</h3> <ul><li><strong>SWC</strong>：基于 Rust 的 JavaScript 编译工具</li> <li><strong>性能</strong>：四核线程中比 Babel 快 70 倍</li> <li><strong>AST 解析</strong>：对传入文件进行抽象语法树解析</li></ul> <h3 id="编译流程"><a href="#编译流程" class="header-anchor">#</a> 编译流程</h3> <div class="language-mermaid extra-class"><pre class="language-mermaid"><code><span class="token keyword">graph</span> TB
    A<span class="token text string">[源代码]</span> <span class="token arrow operator">--&gt;</span> B<span class="token text string">[SWC 解析]</span>
    B <span class="token arrow operator">--&gt;</span> C<span class="token text string">[AST 分析]</span>
    C <span class="token arrow operator">--&gt;</span> D<span class="token text string">[作用域收集]</span>
    D <span class="token arrow operator">--&gt;</span> E<span class="token text string">[依赖分析]</span>
    E <span class="token arrow operator">--&gt;</span> F<span class="token text string">[代码生成]</span>
    F <span class="token arrow operator">--&gt;</span> G<span class="token text string">[输出 chunks]</span>
</code></pre></div><h3 id="作用域收集"><a href="#作用域收集" class="header-anchor">#</a> 作用域收集</h3> <p>Optimizer 会收集不同层级的作用域：</p> <ol><li><strong>全局作用域</strong>：收集 import/export</li> <li><strong>函数作用域</strong>：收集函数内变量</li> <li><strong>$ 调用处理</strong>：收集依赖的标识符</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 作用域分析示例</span>
<span class="token keyword">function</span> <span class="token function">parentFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> outerVariable <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> outerObj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Optimizer 会分析这个 $ 函数的依赖</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>outerVariable<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 依赖 outerVariable</span>
    outerObj<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>           <span class="token comment">// 依赖 outerObj</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="依赖处理"><a href="#依赖处理" class="header-anchor">#</a> 依赖处理</h2> <h3 id="编译前后对比"><a href="#编译前后对比" class="header-anchor">#</a> 编译前后对比</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 编译前</span>
<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> outerVariable <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> outerObj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>outerVariable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outerObj<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 编译后 - 新 chunk (chunk-abc123.js)</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">s_abc123</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>outerVariable<span class="token punctuation">,</span> outerObj<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useLexicalScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>outerVariable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  outerObj<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 编译后 - 原 chunk</span>
<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> outerVariable <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> outerObj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">qrl</span><span class="token punctuation">(</span><span class="token string">'./chunk-abc123.js'</span><span class="token punctuation">,</span> <span class="token string">'s_abc123'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>outerVariable<span class="token punctuation">,</span> outerObj<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="依赖分析算法"><a href="#依赖分析算法" class="header-anchor">#</a> 依赖分析算法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 伪代码：依赖分析过程</span>
<span class="token keyword">function</span> <span class="token function">analyzeDependencies</span><span class="token punctuation">(</span><span class="token parameter">astNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 遍历 AST 节点</span>
  <span class="token function">traverse</span><span class="token punctuation">(</span>astNode<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 检查是否是外部变量</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExternalVariable</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> dependencies<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="qrl-运行时"><a href="#qrl-运行时" class="header-anchor">#</a> QRL 运行时</h2> <h3 id="qrl-函数实现"><a href="#qrl-函数实现" class="header-anchor">#</a> QRL 函数实现</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// QRL 函数的基本结构</span>
<span class="token keyword">function</span> <span class="token function">qrl</span><span class="token punctuation">(</span><span class="token parameter">chunkUrl<span class="token punctuation">,</span> symbolName<span class="token punctuation">,</span> captureData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">$chunkUrl$</span><span class="token operator">:</span> chunkUrl<span class="token punctuation">,</span>
    <span class="token literal-property property">$symbol$</span><span class="token operator">:</span> symbolName<span class="token punctuation">,</span>
    <span class="token literal-property property">$captureRef$</span><span class="token operator">:</span> captureData<span class="token punctuation">,</span>
    
    <span class="token comment">// 执行时动态导入</span>
    <span class="token function-variable function">invoke</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>chunkUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> module<span class="token punctuation">[</span>symbolName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 设置词法作用域</span>
      <span class="token function">setLexicalScope</span><span class="token punctuation">(</span>captureData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="延迟执行机制"><a href="#延迟执行机制" class="header-anchor">#</a> 延迟执行机制</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 延迟执行的实现</span>
<span class="token keyword">class</span> <span class="token class-name">LazyFunction</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">qrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>qrl <span class="token operator">=</span> qrl<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">async</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>qrl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="优化策略"><a href="#优化策略" class="header-anchor">#</a> 优化策略</h2> <h3 id="_1-静态分析优化"><a href="#_1-静态分析优化" class="header-anchor">#</a> 1. 静态分析优化</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 编译时可以确定的优化</span>
<span class="token keyword">function</span> <span class="token function">optimizeStaticCalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> staticValue <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 这个函数不依赖外部变量，可以优化</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'static function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 这个函数依赖外部变量，需要捕获</span>
  <span class="token keyword">const</span> fn2 <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>staticValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-树摇优化"><a href="#_2-树摇优化" class="header-anchor">#</a> 2. 树摇优化</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 未使用的代码会被移除</span>
<span class="token keyword">function</span> <span class="token function">unusedFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个函数如果没有被使用，会被树摇掉</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'unused'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-内联优化"><a href="#_3-内联优化" class="header-anchor">#</a> 3. 内联优化</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 简单的 $ 函数可能被内联</span>
<span class="token keyword">const</span> simpleHandler <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'simple'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 复杂的 $ 函数会被拆分</span>
<span class="token keyword">const</span> complexHandler <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 大量逻辑</span>
  <span class="token function">performComplexCalculation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateMultipleStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">triggerMultipleEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="编译配置"><a href="#编译配置" class="header-anchor">#</a> 编译配置</h2> <h3 id="基础配置"><a href="#基础配置" class="header-anchor">#</a> 基础配置</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// vite.config.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vite'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> qwikVite <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@builder.io/qwik/optimizer'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">qwikVite</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 优化配置</span>
      <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 最小 chunk 大小</span>
        <span class="token literal-property property">minChunkSize</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        <span class="token comment">// 最大 chunk 大小</span>
        <span class="token literal-property property">maxChunkSize</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
        <span class="token comment">// 内联阈值</span>
        <span class="token literal-property property">inlineThreshold</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 调试配置</span>
      <span class="token literal-property property">debug</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 显示编译信息</span>
        <span class="token literal-property property">verbose</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 输出 chunk 信息</span>
        <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="高级配置"><a href="#高级配置" class="header-anchor">#</a> 高级配置</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 自定义 Optimizer 配置</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">qwikVite</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 自定义转换规则</span>
      <span class="token literal-property property">transforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 自定义 $ 函数处理</span>
        <span class="token literal-property property">$</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// 忽略某些函数</span>
          <span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'debugFunction'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token comment">// 强制内联</span>
          <span class="token literal-property property">inline</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'simpleFunction'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 输出配置</span>
      <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// chunk 命名规则</span>
        <span class="token literal-property property">chunkFileNames</span><span class="token operator">:</span> <span class="token string">'chunks/[name]-[hash].js'</span><span class="token punctuation">,</span>
        <span class="token comment">// 资源目录</span>
        <span class="token literal-property property">assetsDir</span><span class="token operator">:</span> <span class="token string">'assets'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="性能指标"><a href="#性能指标" class="header-anchor">#</a> 性能指标</h2> <h3 id="编译性能"><a href="#编译性能" class="header-anchor">#</a> 编译性能</h3> <ul><li><strong>编译速度</strong>：比 Babel 快 70 倍</li> <li><strong>内存使用</strong>：Rust 实现，内存效率高</li> <li><strong>并行处理</strong>：支持多核并行编译</li></ul> <h3 id="运行时性能"><a href="#运行时性能" class="header-anchor">#</a> 运行时性能</h3> <ul><li><strong>chunk 大小</strong>：平均 1-3KB 每个 chunk</li> <li><strong>加载时间</strong>：按需加载，减少初始包大小</li> <li><strong>执行效率</strong>：预编译优化，运行时开销小</li></ul> <h3 id="优化效果对比"><a href="#优化效果对比" class="header-anchor">#</a> 优化效果对比</h3> <table><thead><tr><th>指标</th> <th>传统打包</th> <th>Qwik Optimizer</th></tr></thead> <tbody><tr><td>初始包大小</td> <td>50KB+</td> <td>1KB</td></tr> <tr><td>首次交互时间</td> <td>500ms+</td> <td>100ms</td></tr> <tr><td>代码拆分粒度</td> <td>模块级</td> <td>函数级</td></tr> <tr><td>构建时间</td> <td>较长</td> <td>很快</td></tr></tbody></table> <hr> <p><strong>下一步</strong>: 了解 <a href="/matt-blog/pages/qwik/qwik-extension-tools.html">Qwik 拓展工具</a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/matt-blog/pages/qwik/qwik-introduction.html" class="prev">
        Qwik 介绍
      </a></span> <span class="next"><a href="/matt-blog/pages/qwik/qwik-principles.html">
        Qwik 原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/matt-blog/assets/js/app.71e86090.js" defer></script><script src="/matt-blog/assets/js/2.778bb4ad.js" defer></script><script src="/matt-blog/assets/js/1.f8bb34da.js" defer></script><script src="/matt-blog/assets/js/34.88ebc733.js" defer></script>
  </body>
</html>
